## 需要的工具和说明
VS Code，Keil，STM32CubeMX，Matlab，Vofa <br>
VS Code拿来编辑代码用，如果习惯了Keil，也可以不同；Keil就不做说明了；通过stm32cubeMX打开项目下的ioc文件，里面包含每个IO管脚的详细配置，此外，项目的底层是基于LL库完成的；Matlab软件一方面可以拿来用来做滤波器的数字实现，另一方面可以拿来做”虚拟示波器“，由JLink或者SWD上传数据，并通过Segger RTT或者串口方式实时获取电机的相电流、dq轴电流等参数；Vofa这个软件主要是拿来和MCU通讯的，以及串口调试。<br>
## 关于主要的中断的说明
systick中断每1ms产生一次，主要负责对电机的温度、母线电压实时监控、接受上位机的控制命令<br>
ADC中断是由Timer的UEV（Update Event）事件触发的，触发频率默认为10Khz，主要负责电流环（1个周期算一次）、速度环（10个周期算一次）的运算，同时也负责磁极位置和编码器的对齐操作<br>
## 对于编码器的支持情况
目前，由于使能了SPI协议、IIC协议，同时也使能了Timer的HALL、ABZ接口，因此，理论上能够支持大部分的增量式或者绝对式编码器，软件默认支持的是增量式编码器，参数为2500PPR<br>
## 其他
目前只是个简易的Demo，测试用的是SPMSM，软件中也包含了一些其他的无感算法，例如：高频注入、极性辨识、非线性磁链、参数辨识的，但这些算法对电机的磁路结构、硬件驱动器的参数有有要求<br>
## 修改情况
### 2024.7.7
第一次上传<br>
### 2024.7.8
1.修改了IncABZEncoder类型，使其能够支持X4，X2，X1模式<br>
2.修改了传感器速度以及位置计算的方式，原来是constant的计算系数，现在改为了var类型的计算系数<br>
3.将速度环的计算也放在了ADC中断，只是计算频率和电流环不一样<br>
### 2024.7.16
1.添加了电阻、电感的无位置传感器辨识方法<br>
2.可通过宏定义CCMRAM来更改函数、变量所处的section，以加速代码的执行速度<br>
3.解决了使用增量式ABZ编码器时电机无法达到额定转速（之前仅能达到额定转速的30%）的问题<br>
### 2024.7.18
1.整理了源文件：将非线性磁链合并入高速无感控制、高频注入法以及磁极辨识等合并入低速无感控制<br>
2.调整了使用增量式编码器作为FOC控制时的需要用到的函数，优化了函数调用<br>
3.调整了过压以及欠电压检测的阈值时间，以避免电机从额定转速短时间降到零速时触发过压保护使得系统复位<br>
4.修复了一个bug，该bug容易导致电机在使用增量式编码器时产生意外的转动<br>
### 2024.7.20
1.进一步修改了过压保护的阈值，保护值设定为母线电压的1.5倍（底层的硬件驱动支持最高2倍的母线电压）<br>
2.进一步修改了使用增量式编码器测速的方法，旧方法在电机工作在电频率1Hz或者更低时其转速不稳定。整体解决方案是在高速时使用M法测速，而在低速时使用M/T法测速，不使用T法的原因在于会使得高低速切换不易实现，而使用M/T法测速的代价是会额外占据一个16位的定时器<br>
### 2024.7.30
1.原先的电流采样在ud=uq=0V时的采样值偏大。现调整了校正方法：打开所有下桥臂（同时关断上桥臂），然后对采集若干个相电流，求其中位值作为ADC电流采样时的偏置，新方案相比原先，降低了约20%的幅值<br>
2.增添了对非线性磁链观测器、开环IF拖动的支持，并提供Debug方法：Debug时需要连接电机的增量式ABZ编码器以对比观测器角度和实际电角度的差<br>
3.原先的SVP算法使用固定的母线电压来计算，该方法会导致电机从高速急停时引发硬件过流保护（反电动势导致了母线电压升高许多，以固定电压计算的CCR值会使得电流异常）。现阶段SVP会使用采集到的母线电压来计算，且由于母线电压的采集受噪音影响较大，因此添加了窗口中位值滤波器来确保电压采集的平滑<br>
### 2024.8.7
1.添加对高频注入的支持（目前还未做进一步优化）：其中包括有高频方波注入法和高频脉振注入法<br>
2.添加对绝对值编码器的支持（还未进一步优化，目前处于debug时期）<br>
